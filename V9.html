<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Timetable Viewer v10</title>

<style>
:root{
  --primary:#007aff;
  --bg:#f2f2f7;
  --card:#ffffff;
  --text:#1c1c1e;
  --muted:#8e8e93;

  --selected:#e8f0ff;
  --now:#ff3b30;
  --soon:#ffcc00;
}

*{ box-sizing:border-box }

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,system-ui;
  background:var(--bg);
  color:var(--text);
  padding-bottom:80px;
}

/* ===== NAV ===== */
.nav{
  position:sticky;
  top:0;
  background:var(--primary);
  color:#fff;
  padding:14px 16px;
  display:flex;
  align-items:center;
}

.back-btn{ display:none; cursor:pointer }

.title{
  flex:1;
  text-align:center;
  font-size:18px;
  font-weight:600;
}

/* ===== PAGE ===== */
.page{ display:none; padding:16px }
.page.active{ display:block }

/* ===== MENU ===== */
.menu-btn{
  background:#fff;
  padding:18px;
  border-radius:16px;
  margin-bottom:12px;
  font-size:18px;
  font-weight:600;
  box-shadow:0 6px 16px rgba(0,0,0,.08);
  cursor:pointer;
}

/* ===== FLOOR ===== */
.floor-row{
  background:#fff;
  padding:14px 16px;
  border-radius:14px;
  margin-bottom:8px;
  display:flex;
  justify-content:space-between;
  font-weight:600;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,.06);
}

.floor-row span{ color:var(--muted) }

/* ===== COLLAPSE ===== */
.floor-rooms{
  max-height:0;
  overflow:hidden;
  transition:max-height .25s ease;
}
.floor-rooms.active{ max-height:3000px }

/* ===== ROOM ===== */
.room{
  background:#fff;
  border-radius:18px;
  padding:14px;
  margin:10px 0;
  border:2px solid transparent;
  box-shadow:0 6px 16px rgba(0,0,0,.08);
  cursor:pointer;
}

/* STATES */
.room.selected{
  background:var(--selected);
  border-color:var(--primary);
}
.room.now{
  border-color:var(--now);
}
.room.soon{
  border-color:var(--soon);
}

.room h3{
  margin:0 0 12px;
  font-size:16px;
}

/* ===== TIME GRID ===== */
.time-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(90px,1fr));
  gap:8px;
}
.time{
  background:#e5e5ea;
  padding:6px;
  border-radius:999px;
  font-size:14px;
  text-align:center;
}

/* ===== BOTTOM BAR ===== */
.bottom-bar{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:#fff;
  border-top:1px solid #d1d1d6;
  padding:8px;
  display:none;
  gap:8px;
  overflow-x:auto;
  white-space:nowrap;
}
.bottom-pill{
  flex:0 0 auto;
  background:var(--primary);
  color:#fff;
  padding:6px 12px;
  border-radius:999px;
}
</style>
</head>

<body>

<header class="nav">
  <div id="backBtn" class="back-btn" onclick="showMenu()">← Back</div>
  <div id="headerTitle" class="title">Select Class Group</div>
</header>

<div id="pageMenu" class="page active"></div>
<div id="pageDetail" class="page"></div>
<div id="bottomBar" class="bottom-bar"></div>

<script>
const ENDPOINT =
  "https://s3-ap-southeast-1.amazonaws.com/open-ws/weektimetable";

const pageMenu = document.getElementById("pageMenu");
const pageDetail = document.getElementById("pageDetail");
const headerTitle = document.getElementById("headerTitle");
const backBtn = document.getElementById("backBtn");
const bottomBar = document.getElementById("bottomBar");

const selectedRooms = new Set();
let groupedData = {};
let activeFloor = null;

/* ===== TIME (12-HOUR ONLY) ===== */
function toMinutes12(timeStr){
  // e.g. "2:30 PM"
  const [time, meridian] = timeStr.trim().split(" ");
  let [h, m] = time.split(":").map(Number);

  if(meridian === "PM" && h !== 12) h += 12;
  if(meridian === "AM" && h === 12) h = 0;

  return h*60 + m;
}

function nowMinutes(){
  const d = new Date();
  return d.getHours()*60 + d.getMinutes();
}

function isNow(from,to){
  const now = nowMinutes();
  return now >= toMinutes12(from) && now < toMinutes12(to);
}

function hasSoon(slots){
  const now = nowMinutes();
  return slots.some(s=>{
    const diff = toMinutes12(s.TIME_FROM) - now;
    return diff > 0 && diff <= 30;
  });
}

function todayDatestamp(){
  const d = new Date();
  const m = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
  return `${String(d.getDate()).padStart(2,'0')}-${m[d.getMonth()]}-${String(d.getFullYear()).slice(-2)}`;
}

/* ===== LOAD ===== */
async function load(){
  const data = await (await fetch(ENDPOINT,{cache:"no-store"})).json();
  groupedData = {};

  data
    .filter(r=>r.DATESTAMP===todayDatestamp())
    .forEach(r=>{
      if(!/^[A-Z]-/.test(r.ROOM||"")) return;
      const g = r.ROOM.split("-")[0];
      groupedData[g] ??= {};
      groupedData[g][r.ROOM] ??= [];
      groupedData[g][r.ROOM].push(r);
    });

  showMenu();
}

/* ===== MENU ===== */
function showMenu(){
  headerTitle.textContent="Select Class Group";
  backBtn.style.display="none";
  pageMenu.innerHTML="";
  pageMenu.classList.add("active");
  pageDetail.classList.remove("active");

  Object.keys(groupedData).sort().forEach(g=>{
    const btn=document.createElement("div");
    btn.className="menu-btn";
    btn.textContent=g;
    btn.onclick=()=>showDetail(g);
    pageMenu.appendChild(btn);
  });
}

/* ===== DETAIL ===== */
function showDetail(group){
  headerTitle.textContent=`Group ${group}`;
  backBtn.style.display="block";
  pageMenu.classList.remove("active");
  pageDetail.classList.add("active");

  const floors={};
  Object.keys(groupedData[group]).forEach(room=>{
    const f=room.split("-")[1];
    floors[f] ??= [];
    floors[f].push(room);
  });

  pageDetail.innerHTML = Object.keys(floors).sort().map(floor=>{
    const open = activeFloor===floor;

    return `
      <div class="floor-row" onclick="toggleFloor('${floor}','${group}')">
        Floor ${floor}
        <span>${open?"▾":"▸"}</span>
      </div>
      <div class="floor-rooms ${open?"active":""}">
        ${open?floors[floor].map(room=>{
          const slots = groupedData[group][room];
          const cls = [
            selectedRooms.has(room) ? "selected" : "",
            slots.some(s=>isNow(s.TIME_FROM,s.TIME_TO)) ? "now" :
            hasSoon(slots) ? "soon" : ""
          ].join(" ");

          return `
            <div class="room ${cls}" onclick="toggleSelect('${room}',event)">
              <h3>${room}</h3>
              <div class="time-grid">
                ${slots.map(s=>`<div class="time">${s.TIME_FROM}–${s.TIME_TO}</div>`).join("")}
              </div>
            </div>`;
        }).join(""):""}
      </div>`;
  }).join("");
}

function toggleFloor(floor,group){
  activeFloor = activeFloor===floor ? null : floor;
  showDetail(group);
}

function toggleSelect(room,e){
  e.stopPropagation();
  selectedRooms.has(room)?selectedRooms.delete(room):selectedRooms.add(room);
  renderBottom();
  showDetail(headerTitle.textContent.split(" ").pop());
}

function renderBottom(){
  bottomBar.innerHTML="";
  if(!selectedRooms.size){
    bottomBar.style.display="none";
    return;
  }
  bottomBar.style.display="flex";
  selectedRooms.forEach(r=>{
    const p=document.createElement("div");
    p.className="bottom-pill";
    p.textContent=r;
    bottomBar.appendChild(p);
  });
}

load();
</script>

</body>
</html>
